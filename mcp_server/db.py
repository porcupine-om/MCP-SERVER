import sqlite3
import random
import os

DB_PATH = "products.db"

# Тестовые данные для заполнения БД
TEST_PRODUCTS = [
    # Овощи
    ("Морковь", "Овощи", 45.50),
    ("Помидоры", "Овощи", 120.00),
    ("Огурцы", "Овощи", 85.00),
    ("Картофель", "Овощи", 35.00),
    ("Лук репчатый", "Овощи", 40.00),
    ("Капуста белокочанная", "Овощи", 50.00),
    ("Перец болгарский", "Овощи", 150.00),
    ("Баклажаны", "Овощи", 180.00),
    ("Кабачки", "Овощи", 60.00),
    ("Свекла", "Овощи", 42.00),
    
    # Фрукты
    ("Яблоки", "Фрукты", 80.00),
    ("Бананы", "Фрукты", 90.00),
    ("Апельсины", "Фрукты", 110.00),
    ("Мандарины", "Фрукты", 130.00),
    ("Груши", "Фрукты", 95.00),
    ("Виноград", "Фрукты", 200.00),
    ("Клубника", "Фрукты", 350.00),
    ("Черешня", "Фрукты", 400.00),
    ("Персики", "Фрукты", 180.00),
    ("Сливы", "Фрукты", 120.00),
    
    # Молочные продукты
    ("Молоко 3.2%", "Молочные продукты", 75.00),
    ("Кефир", "Молочные продукты", 65.00),
    ("Сметана 20%", "Молочные продукты", 95.00),
    ("Творог", "Молочные продукты", 180.00),
    ("Сыр твердый", "Молочные продукты", 450.00),
    ("Йогурт", "Молочные продукты", 55.00),
    ("Масло сливочное", "Молочные продукты", 320.00),
    ("Сыр плавленый", "Молочные продукты", 120.00),
    ("Ряженка", "Молочные продукты", 70.00),
    ("Творожная масса", "Молочные продукты", 140.00),
    
    # Мясо и птица
    ("Говядина", "Мясо и птица", 450.00),
    ("Свинина", "Мясо и птица", 380.00),
    ("Курица целая", "Мясо и птица", 250.00),
    ("Куриное филе", "Мясо и птица", 320.00),
    ("Голени куриные", "Мясо и птица", 200.00),
    ("Фарш говяжий", "Мясо и птица", 400.00),
    ("Колбаса докторская", "Мясо и птица", 350.00),
    ("Сосиски", "Мясо и птица", 180.00),
    ("Бекон", "Мясо и птица", 420.00),
    ("Индейка", "Мясо и птица", 380.00),
    
    # Хлеб и выпечка
    ("Хлеб белый", "Хлеб и выпечка", 45.00),
    ("Хлеб черный", "Хлеб и выпечка", 50.00),
    ("Батон нарезной", "Хлеб и выпечка", 42.00),
    ("Булочки сдобные", "Хлеб и выпечка", 35.00),
    ("Пирожное", "Хлеб и выпечка", 85.00),
    ("Торт", "Хлеб и выпечка", 450.00),
    ("Печенье", "Хлеб и выпечка", 120.00),
    ("Круассан", "Хлеб и выпечка", 55.00),
    ("Пончики", "Хлеб и выпечка", 65.00),
    ("Вафли", "Хлеб и выпечка", 95.00),
    
    # Напитки
    ("Вода минеральная", "Напитки", 35.00),
    ("Сок апельсиновый", "Напитки", 120.00),
    ("Сок яблочный", "Напитки", 110.00),
    ("Кока-кола", "Напитки", 85.00),
    ("Пепси", "Напитки", 85.00),
    ("Чай черный", "Напитки", 95.00),
    ("Чай зеленый", "Напитки", 110.00),
    ("Кофе молотый", "Напитки", 350.00),
    ("Кофе растворимый", "Напитки", 280.00),
    ("Лимонад", "Напитки", 65.00),
    
    # Крупы и макароны
    ("Рис", "Крупы и макароны", 95.00),
    ("Гречка", "Крупы и макароны", 85.00),
    ("Овсянка", "Крупы и макароны", 75.00),
    ("Макароны", "Крупы и макароны", 65.00),
    ("Перловка", "Крупы и макароны", 55.00),
    ("Пшено", "Крупы и макароны", 60.00),
    ("Манка", "Крупы и макароны", 50.00),
    ("Булгур", "Крупы и макароны", 120.00),
    ("Киноа", "Крупы и макароны", 350.00),
    ("Спагетти", "Крупы и макароны", 75.00),
    
    # Консервы
    ("Тушенка", "Консервы", 180.00),
    ("Рыба консервированная", "Консервы", 150.00),
    ("Горошек зеленый", "Консервы", 65.00),
    ("Кукуруза консервированная", "Консервы", 70.00),
    ("Огурцы маринованные", "Консервы", 95.00),
    ("Помидоры консервированные", "Консервы", 85.00),
    ("Фасоль консервированная", "Консервы", 75.00),
    ("Ананасы консервированные", "Консервы", 120.00),
    ("Персики консервированные", "Консервы", 110.00),
    ("Сардины", "Консервы", 140.00),
    
    # Сладости
    ("Шоколад молочный", "Сладости", 95.00),
    ("Шоколад темный", "Сладости", 110.00),
    ("Конфеты шоколадные", "Сладости", 280.00),
    ("Мармелад", "Сладости", 120.00),
    ("Зефир", "Сладости", 150.00),
    ("Халва", "Сладости", 180.00),
    ("Вафли шоколадные", "Сладости", 95.00),
    ("Пряники", "Сладости", 140.00),
    ("Леденцы", "Сладости", 65.00),
    ("Жевательная резинка", "Сладости", 35.00),
    
    # Замороженные продукты
    ("Мороженое пломбир", "Замороженные продукты", 120.00),
    ("Пельмени", "Замороженные продукты", 280.00),
    ("Блинчики замороженные", "Замороженные продукты", 150.00),
    ("Овощи замороженные", "Замороженные продукты", 180.00),
    ("Ягоды замороженные", "Замороженные продукты", 250.00),
    ("Рыба замороженная", "Замороженные продукты", 350.00),
    ("Курица замороженная", "Замороженные продукты", 200.00),
    ("Пицца замороженная", "Замороженные продукты", 320.00),
    ("Наггетсы куриные", "Замороженные продукты", 280.00),
    ("Картофель фри", "Замороженные продукты", 180.00),
]


def get_connection():
    """Создает и возвращает соединение с БД"""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn


def init_db():
    """Инициализирует БД и создает таблицу products"""
    conn = get_connection()
    cursor = conn.cursor()
    
    # Создаем таблицу
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            category TEXT NOT NULL,
            price REAL NOT NULL
        )
    """)
    
    # Проверяем, есть ли уже данные
    cursor.execute("SELECT COUNT(*) FROM products")
    count = cursor.fetchone()[0]
    
    # Если таблица пустая, заполняем тестовыми данными
    if count == 0:
        cursor.executemany(
            "INSERT INTO products (name, category, price) VALUES (?, ?, ?)",
            TEST_PRODUCTS
        )
        conn.commit()
        print(f"База данных инициализирована. Добавлено {len(TEST_PRODUCTS)} товаров.")
    
    conn.close()


def get_all_products():
    """Возвращает все товары из БД"""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM products ORDER BY id")
    products = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return products


def find_product_by_name(name):
    """Ищет товары по имени (частичное совпадение)"""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM products WHERE name LIKE ? ORDER BY name",
        (f"%{name}%",)
    )
    products = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return products


def find_products_by_category(category):
    """Ищет товары по категории"""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM products WHERE category LIKE ? ORDER BY name",
        (f"%{category}%",)
    )
    products = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return products


def find_product_by_id(product_id):
    """Ищет товар по ID"""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM products WHERE id = ?", (product_id,))
    row = cursor.fetchone()
    conn.close()
    return dict(row) if row else None


def add_product(name, category, price):
    """Добавляет новый товар в БД"""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO products (name, category, price) VALUES (?, ?, ?)",
        (name, category, price)
    )
    product_id = cursor.lastrowid
    conn.commit()
    conn.close()
    return find_product_by_id(product_id)

